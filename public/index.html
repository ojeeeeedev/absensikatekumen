<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Presensi Katekumen</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">
    
    <style>
      /* --- GLOBAL RESET & TRANSITIONS --- */
      * { box-sizing: border-box; transition: all 0.2s ease-out; }

      html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        /* background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); */
        background: linear-gradient(135deg, #330B0D 0%, #0a0a0a 70%);
        color: #e0e0e0; /* Slightly softer white for better reading */
        font-family: "Inter", sans-serif;
        display: flex; justify-content: center; align-items: center;
      }

      /* --- FLOATING GLASS CONTAINER --- */
      .glass-container {
        background: rgba(25, 25, 25, 0.4);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px); /* For Safari */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        padding: 1.5rem; margin: 1rem 0;
        width: 95%;
        max-width: 450px;
        display: flex; flex-direction: column; align-items: center;
        max-height: 95vh;
        position: relative; z-index: 2;
      }

      /* --- ON-LOAD ANIMATIONS --- */
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .glass-container > * {
        opacity: 0; /* Start hidden */
        animation: fadeInUp 0.6s ease-out forwards;
      }
      .glass-container > h1 { animation-delay: 0.1s; }
      .glass-container > h2 { animation-delay: 0.2s; }
      .glass-container > #topic-trigger { animation-delay: 0.3s; }
      .glass-container > #reader-container { animation-delay: 0.4s; }
      .glass-container > #status { animation-delay: 0.5s; }
      .glass-container > footer { animation-delay: 0.6s; }

      /* --- LIQUID GLASS BACKGROUND --- */
      .liquid-background {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 1;
        overflow: hidden;
      }
      .liquid-shape {
        position: absolute;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.7;
      }
      .shape1 {
        width: 350px; height: 350px;
        background: #9A2126;
        top: -100px; left: -150px;
        animation: move1 25s infinite alternate;
      }
      .shape2 {
        width: 250px; height: 250px;
        background: #4a148c; /* A complementary deep purple */
        bottom: -50px; right: -80px;
        animation: move2 30s infinite alternate;
      }
      @keyframes move1 {
        from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(200px, 300px) rotate(180deg); }
      }
      @keyframes move2 {
        from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(-250px, -200px) rotate(-180deg); }
      }

      h1 { margin: 0 0 0.4rem 0; font-size: 1.8rem; text-align: center; color: #fff; font-family: 'Playfair Display', serif; font-weight: 500; }
      h2 { margin: 0; font-size: 1rem; color: #888; text-align: center; font-weight: 400; }

      /* --- TOPIC SELECTOR --- */
      .topic-selector-btn {
        width: 100%;
        background: #222; color: #ddd;
        font-size: .95rem; text-align: left;
        padding: 0.8rem 1rem; 
        border-radius: 8px; border: 1px solid #333; 
        margin-top: 1rem;
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer;
      }
      .topic-selector-btn:after { content: '‚ñº'; font-size: 0.7rem; color: #666; }

      /* --- MODAL --- */
      #topic-modal {
        display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 999;
        flex-direction: column; justify-content: flex-end;
      }
      .modal-content {
        background: #1a1a1a;
        border-top-left-radius: 16px; border-top-right-radius: 16px;
        padding: 1rem; max-height: 70vh; overflow-y: auto;
        display: flex; flex-direction: column; gap: 10px;
        border-top: 1px solid #333;
      }
      #topic-search-input {
        width: 100%;
        padding: 0.8rem 1rem;
        margin-bottom: 10px;
        background: #333;
        border: 1px solid #444;
        border-radius: 8px;
        color: #eee;
        font-size: 0.9rem;
      }
      .topic-option {
        padding: 1rem; background: #2a2a2a; border-radius: 8px;
        text-align: left; font-size: 0.9rem; color: #ccc;
        border: 1px solid #333; cursor: pointer;
      }
      .topic-option.active {
        border-color: #9A2126; background: #332222; color: #E57373;
      }
      .modal-close-btn {
        margin-top: 15px; padding: 1rem; background: #d32f2f; color: white;
        text-align: center; border-radius: 8px; cursor: pointer;
        position: sticky; bottom: 0;
      }

      /* --- CAMERA CONTAINER --- */
      #reader-container {
        position: relative;
        width: 100%;
        aspect-ratio: 1 / 1; 
        margin-top: 1rem; border-radius: 14px;
        overflow: hidden; 
        background: #000;
        border: 1px solid #333; /* Simple border instead of corners */
      }
      #reader { width: 100%; height: 100%; object-fit: cover; }

      /* --- LOADING SPINNER --- */
      #camera-loader {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #111;
        display: flex; justify-content: center; align-items: center;
        color: #888; font-size: 0.9rem;
        z-index: 10;
        flex-direction: column; gap: 15px;
      }
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #9A2126;
        border-radius: 50%; width: 30px; height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* --- STATUS BOX (Text Only, No Bold) --- */
      #status {
        margin-top: 1rem; width: 100%;
        padding: 1rem; border-radius: 8px; min-height: 60px;
        display: flex; align-items: center; gap: 12px; text-align: left;    
        font-weight: 400; /* Ensuring normal weight */
      }
      
      /* Simple Status Colors */
      .idle { background: #111; color: #aaa; border: 1px dashed #333; justify-content: center; }
      .success { background: #1b5e20; color: #e8f5e9; border: 1px solid #2e7d32; }
      .error { background: #b71c1c; color: #ffebee; border: 1px solid #d32f2f; }
      .processing { background: #332222; color: #E57373; border: 1px solid #9A2126; justify-content: center; }

      /* Typography inside status */
      .status-text-container { display: flex; flex-direction: column; }
      .main-text { font-size: 1rem; margin-bottom: 4px; font-weight: 400; } /* Not bold */
      .sub-text { font-size: 0.8rem; opacity: 0.8; font-weight: 300; }

      footer { font-size: 0.7rem; color: #555; margin-top: 1.5rem; text-align: center; }
      footer a { color: #9A2126; text-decoration: none; }
    </style>
  </head>

  <body>
    <div class="liquid-background">
      <div class="liquid-shape shape1"></div>
      <div class="liquid-shape shape2"></div>
    </div>

    <main class="glass-container">
      <h1>Presensi Katekumen</h1>
      <h2>Gereja Katedral St. Petrus Bandung</h2>

      <div id="topic-trigger" class="topic-selector-btn" onclick="openTopicModal()">
          Pilih Topik...
      </div>

      <div id="reader-container">
          <div id="camera-loader">
              <div class="spinner"></div>
              <span style="margin-top:10px;">Memuat Kamera...</span>
          </div>
          <div id="reader"></div>
      </div>

      <div id="status" class="idle"></div> 

      <footer>
        ¬© 2025 Tim TI Katekumen<br>
        Kontak: <a href="https://wa.me/6281221752365">Andar 0812 2175 2365</a>
      </footer>
    </main>

    <div id="topic-modal">
        <div class="modal-content">
            <h3 style="margin: 0 0 10px 0; text-align: center; color: #fff; font-weight:400;">Pilih Topik Absensi</h3>
            <input type="text" id="topic-search-input" oninput="filterTopics()" placeholder="üîç Cari topik...">
            <div id="topic-list-container">
                <div style="text-align:center; padding:20px; color:#666;">Memuat topik...</div>
            </div>
            <div class="modal-close-btn" onclick="closeTopicModal()">Tutup</div>
        </div>
    </div>

    <script>
      let html5QrcodeScanner; // Will be initialized later
      let scanCooldown = false;
      let SCRIPT_MAP = {}; 
      let selectedWeek = null; 

      // --- MODAL FUNCTIONS ---
      function openTopicModal() { document.getElementById('topic-modal').style.display = 'flex'; }
      function closeTopicModal() { document.getElementById('topic-modal').style.display = 'none'; }

      function selectTopic(week, name, element) {
        selectedWeek = week;
        document.getElementById('topic-trigger').innerText = `${week}. ${name}`;
        document.getElementById('topic-trigger').style.borderColor = "#9A2126";
        document.querySelectorAll('.topic-option').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        setTimeout(closeTopicModal, 200);
      }

      function filterTopics() {
        const searchTerm = document.getElementById('topic-search-input').value.toLowerCase();
        const topics = document.querySelectorAll('.topic-option');
        topics.forEach(topic => {
          const topicText = topic.textContent.toLowerCase();
          if (topicText.includes(searchTerm)) {
            topic.style.display = 'block';
          } else {
            topic.style.display = 'none';
          }
        });
      }

      // --- DATA LOADING ---
      async function loadScriptMap() {
        try {
          const res = await fetch("/config.json");
          SCRIPT_MAP = await res.json();
        } catch (e) { showStatus("Gagal memuat konfigurasi", "error"); }
      }

      async function loadTopikList() {
        const listContainer = document.getElementById("topic-list-container");
        try {
          const res = await fetch(`/api/absensi?action=topik&classCode=SAB`);
          const data = await res.json();

          if (data.status === "ok" && Array.isArray(data.topik)) {
            listContainer.innerHTML = "";
            data.topik.forEach((item) => {
              const div = document.createElement("div");
              div.className = "topic-option";
              div.textContent = `${item.week}. ${item.name}`;
              div.onclick = () => selectTopic(item.week, item.name, div);
              listContainer.appendChild(div);
            });
            if(data.topik.length > 0) {
                const lastTopic = data.topik[data.topik.length - 1];
                selectTopic(lastTopic.week, lastTopic.name, listContainer.lastChild);
            }
          } else {
            listContainer.innerHTML = `<div style="text-align:center; color:#d32f2f;">Data topik tidak ditemukan.</div>`;
          }
        } catch (err) {
          listContainer.innerHTML = `<div style="text-align:center; color:#d32f2f;">Gagal memuat topik.</div>`;
        }
      }

      // --- STATUS HANDLER (Text Only) ---
      function showStatus(mainText, type, subText = "") {
        const el = document.getElementById("status");
        
        // Using simple emojis as text indicators
        let icon = "";
        if (type === 'success') icon = "‚úÖ";
        else if (type === 'error') icon = "‚ö†Ô∏è";
        else if (type === 'processing') icon = "‚è≥";
        else icon = "üì∑";

        if (subText) {
            el.innerHTML = `
                <span style="font-size: 1.5rem; margin-right: 10px;">${icon}</span>
                <div class="status-text-container">
                    <div class="main-text">${mainText}</div>
                    <div class="sub-text">${subText}</div>
                </div>
            `;
        } else {
            el.innerHTML = `
                <span style="font-size: 1.5rem; margin-right: 10px;">${icon}</span>
                <div class="main-text">${mainText}</div>
            `;
        }
        el.className = type;
      }

      function resetStatus() { showStatus("Silakan pindai kode QR berikutnya", "idle"); }

      // --- SCANNER LOGIC ---
      async function handleScan(decodedText) {
        if (scanCooldown) return;
        if (!selectedWeek) {
           showStatus("Pilih topik terlebih dahulu!", "error");
           openTopicModal(); return;
        }

        scanCooldown = true;
        showStatus("Memproses...", "processing");

        const parts = decodedText.split("/");
        const classCode = parts[1]?.toUpperCase();

        if (!classCode || !SCRIPT_MAP[classCode]) {
          showStatus(`Kode kelas tidak valid: ${classCode || '-'}`, "error");
          setTimeout(() => { scanCooldown = false; resetStatus(); }, 3000);
          return;
        }

        try {
          const response = await fetch("/api/absensi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ studentId: decodedText, week: selectedWeek, classCode }),
          });

          const text = await response.text();
          let res = JSON.parse(text);

          if (res.status === "ok") {
            showStatus(res.name, "success", `ID: ${res.studentId} ‚Ä¢ Topik ${selectedWeek}`);
          } else if (res.status === "duplicate") {
            showStatus("Sudah Hadir", "error", res.message);
          } else {
            showStatus("Gagal", "error", res.message);
          }
        } catch (error) {
          showStatus("Error Koneksi", "error", "Gagal menghubungi server");
        } finally {
          setTimeout(() => { scanCooldown = false; resetStatus(); }, 4000);
        }
      }

      async function startScanner() {
        if (Object.keys(SCRIPT_MAP).length === 0) await loadScriptMap();

        const scanConfig = { 
            fps: 10, // Increased for faster recognition
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: {
                // Use native BarcodeDetector if supported, for faster scans
                useBarCodeDetectorIfSupported: true
            },
            // Pass video constraints directly into the config object
            videoConstraints: {
                facingMode: "environment",
                width: { ideal: 720 },
                height: { ideal: 720 }
            }
        };

        html5QrcodeScanner = new Html5Qrcode("reader", /* verbose= */ false);
        html5QrcodeScanner.start(
          { facingMode: "environment" }, // Request rear camera
          scanConfig,
          handleScan
        ).then(() => {
            document.getElementById("camera-loader").style.display = "none";
            resetStatus();
        }).catch(err => {
            const loader = document.getElementById("camera-loader");
            loader.innerHTML = '<div style="color:#d32f2f; text-align:center">Izin kamera ditolak<br>atau kamera tidak tersedia</div>';
        });
      }

      window.onload = async () => {
        showStatus("Memuat sistem...", "processing");
        await Promise.all([loadScriptMap(), loadTopikList()]);
        startScanner();
      };
    </script>
  </body>
</html>