<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Katekumen</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!--link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" /-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        font-family: "Inter", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
        font-kerning: auto;
      }
      h1 {
        margin: 1rem 0 0.4rem 0;
        font-size: 1.5rem;
        color: #ffffff;
        text-align: center;
        font-kerning: auto;
      }
      h2 {
        margin: 0;
        font-size: 1rem;
        color: #aaa;
        font-kerning: auto;
        text-align: center;
        font-weight: 500;
      }
      label {
        font-size: 1rem;
        margin-top: 0.6rem;
      }
      select {
        width: 90%;
        max-width: 420px;
        background: #111;
        color: #fff;
        font-size: 1rem;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #333;
        margin-top: 0.4rem;
      }
      #reader {
        width: 92vw;
        max-width: 420px;
        aspect-ratio: 1 / 1;
        margin-top: 1rem;
        border-radius: 14px;
        overflow: hidden;
        background: #000;
      }
      #status {
        margin-top: 1rem;
        font-size: 0.8rem;
        font-weight: 400;
        text-align: center;
        width: 90%;
        max-width: 420px;
        padding: 0.8rem;
        border-radius: 8px;
        transition: opacity 0.4s ease;
      }
      .success { background: #00c851; color: #fff; }
      .error { background: #ff4444; color: #fff; }
      .student-id {
        font-size: 0.7rem;
        font-weight: 300;
        opacity: 0.9;
      }
      footer {
        font-size: 0.65rem;
        color: #666;
        margin-top: auto;
        padding-bottom: 0.6rem;
        line-height: 1.2;
        text-align: center;
      }
      footer a {
      color: #72b7ff;   /* light blue */
      text-decoration: none;
      }

      footer a:hover {
      color: #a8d4ff;   /* even lighter on hover */
      text-decoration: underline;
      }

    </style>
  </head>

  <body>
    <h1>Presensi Katekumen Dewasa</h1>
    <h2>Gereja Katedral St. Petrus Bandung</h2>

    <label for="week">Pilih Topik:</label><br>
    <select id="week">
      <option disabled selected>Memuat daftar topik...</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

    <footer>
      <b>¬© 2025 Tim TI Katekumen Dewasa - St. Petrus Katedral Bandung</b><br>
      Ada kendala/kritik/saran?<br>
      Kontak: <b>Andar </b>
      <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 432 432"><path fill="#ffffff" d="M364.5 65Q427 127 427 214.5T364.5 364T214 426q-54 0-101-26L0 429l30-109Q2 271 2 214q0-87 62-149T214 3t150.5 62zM214 390q73 0 125-51.5T391 214T339 89.5T214 38T89.5 89.5T38 214q0 51 27 94l4 6l-18 65l67-17l6 3q42 25 90 25zm97-132q9 5 10 7q4 6-3 25q-3 8-15 15.5t-21 9.5q-18 2-33-2q-17-6-30-11q-8-4-15.5-8.5t-14.5-9t-13-9.5t-11.5-10t-10.5-10.5t-8.5-9.5t-7-8.5t-5.5-7t-3.5-5L128 222q-22-29-22-55q0-24 19-44q6-7 14-7q6 0 10 1q8 0 12 9q2 3 6 13l7 17.5l3 8.5q3 5 1 9q-3 7-5 9l-3 3l-3 3.5l-2 2.5q-6 6-3 11q13 22 30 37q13 11 43 26q7 3 11-1q12-15 17-21q4-6 12-3q6 3 36 17z"/></svg> </i>
      <a href="https://wa.me/6281221752365?text=Halo%20Andar%21%20Saya%20mau%20bertanya%20tentang%20aplikasi%20absensi%20katekumen%2E">0812 2175 2365</a></br></footer>
    </footer>

    <script>
  const reader = new Html5Qrcode("reader");
  let scanCooldown = false;
  let SCRIPT_MAP = {}; 
  let currentScriptUrl = ""; 

  // Load JSON mapping
  async function loadScriptMap() {
    const res = await fetch("/config.json");
    SCRIPT_MAP = await res.json();
  }

 async function loadTopikList() {
  const select = document.getElementById("week");
  select.innerHTML = `<option disabled selected>Memuat daftar topik...</option>`;

  try {
    // Default class for loading topics
    const res = await fetch(`/api/absensi?action=topik&classCode=SAB`);
    const data = await res.json();

    select.innerHTML = "";

    if (data.status === "ok" && Array.isArray(data.topik)) {
      data.topik.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = item.week;
        opt.textContent = `${item.week}. ${item.name}`;
        select.appendChild(opt);
      });
    } else {
      select.innerHTML = `<option disabled>Data topik tidak ditemukan</option>`;
    }
  } catch (err) {
    console.error("Gagal memuat daftar topik:", err);
    select.innerHTML = `<option disabled>‚ö†Ô∏è Gagal memuat topik</option>`;
  }
}


  function showStatus(text, type) {
    const el = document.getElementById("status");
    el.innerHTML = text;
    el.className = type;
    el.style.opacity = "1";
  }

  function clearStatus() {
    const el = document.getElementById("status");
    el.style.opacity = "0";
    setTimeout(() => {
      el.innerHTML = "üì∑ Silakan pindai kode QR berikutnya";
      el.className = "";
      el.style.opacity = "1";
    }, 400);
  }

  async function handleScan(decodedText) {
    if (scanCooldown) return;
    scanCooldown = true;

    const parts = decodedText.split("/");
const classCode = parts[1]?.toUpperCase();

if (!classCode || !SCRIPT_MAP[classCode]) {
  showStatus(`‚ùå Kode kelas tidak valid: ${classCode}`, "error");
  scanCooldown = false;
  return;
}


    currentScriptUrl = SCRIPT_MAP[classCode];

    const week = document.getElementById("week").value;
    showStatus("‚è≥ Menyimpan presensi...", "");

    fetch("/api/absensi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        studentId: decodedText,
        week,
        classCode
      }),
    })
      .then(async (r) => {
        const text = await r.text();

        let res;
        try {
          res = JSON.parse(text);
        } catch {
          showStatus("‚ö†Ô∏è Server mengirim data tidak valid.", "error");
          return;
        }

        if (res.status === "ok") {
          showStatus(
            `‚úÖ <b>${res.name}</b><br> hadir </br> <b>Topik ${week}</b><br><span class="student-id">${res.studentId.toUpperCase()}</span>`,
            "success"
          );
        } else if (res.status === "duplicate") {
          showStatus(`‚ö†Ô∏è ${res.message}`, "error");
        } else {
          showStatus(`‚ùå ${res.message}`, "error");
        }
      })
      .catch(() => {
        showStatus("‚ö†Ô∏è Koneksi error!", "error");
      })
      .finally(() => {
        setTimeout(() => {
          scanCooldown = false;
          clearStatus();
        }, 5000);
      });
  }

  async function startScanner() {
    await reader.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 350, height: 350 } },
      handleScan
    );
  }

  window.onload = async () => {
    await loadScriptMap();
    await loadTopikList();
    startScanner();
  };
</script>

  </body>
</html>
