<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Katekumen</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        font-family: "Inter", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }
      h1 {
        margin: 1rem 0 0.4rem 0;
        font-size: 1.8rem;
        color: #00aaff;
        text-align: center;
      }
      label {
        font-size: 1.2rem;
        margin-top: 0.6rem;
      }
      select {
        width: 90%;
        max-width: 420px;
        background: #111;
        color: #fff;
        font-size: 1.1rem;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #333;
        margin-top: 0.4rem;
      }
      #reader {
        width: 92vw;
        max-width: 420px;
        aspect-ratio: 1 / 1;
        margin-top: 1rem;
        border-radius: 14px;
        overflow: hidden;
        background: #000;
      }
      #status {
        margin-top: 1rem;
        font-size: 1.1rem;
        font-weight: 500;
        text-align: center;
        width: 90%;
        max-width: 420px;
        padding: 0.8rem;
        border-radius: 8px;
        line-height: 1.4;
      }
      .success { background: #00c851; color: #fff; }
      .error { background: #ff4444; color: #fff; }
      .id {
        font-size: 0.9rem;
        color: #ddd;
        display: block;
        margin-top: 0.2rem;
      }
      footer {
        font-size: 0.9rem;
        color: #666;
        margin-top: auto;
        padding-bottom: 0.6rem;
      }
    </style>
  </head>

  <body>
    <h1>Absensi Katekumen</h1>

    <label for="week">Pilih Topik:</label>
    <select id="week">
      <option value="1">Topik 1</option>
      <option value="2">Topik 2</option>
      <option value="3">Topik 3</option>
      <option value="4">Topik 4</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

    <footer>Â© 2025 IT Katekumen Dewasa - St. Petrus Katedral</footer>

    <script>
      const reader = new Html5Qrcode("reader");
      let scanningDisabled = false;

      // âœ… New, reliable supermarket beep (from jsDelivr)
      const beepSound = new Audio("https://cdn.jsdelivr.net/gh/aleene/audio-library/beep.mp3");
      beepSound.preload = "auto";

      async function startScanner() {
        try {
          if (reader.isScanning) await reader.stop();

          await reader.start(
            { facingMode: { exact: "environment" } },
            { fps: 10, qrbox: { width: 350, height: 350 } },
            (decodedText) => handleScan(decodedText)
          );
        } catch (err) {
          console.warn("Camera Error, fallback to auto:", err);
          try {
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length > 0) {
              const backCam =
                cameras.find(
                  (cam) =>
                    cam.label.toLowerCase().includes("back") ||
                    cam.label.toLowerCase().includes("rear")
                ) || cameras[0];

              await reader.start(
                { deviceId: { exact: backCam.id } },
                { fps: 10, qrbox: { width: 350, height: 350 } },
                (decodedText) => handleScan(decodedText)
              );
            } else {
              showStatus("ðŸš« Tidak ada kamera yang terdeteksi", "error");
            }
          } catch (fallbackErr) {
            console.error("Camera Fallback Error:", fallbackErr);
            showStatus("âš ï¸ Tidak bisa mengakses kamera", "error");
          }
        }
      }

      function showStatus(text, type) {
        const el = document.getElementById("status");
        el.innerHTML = text;
        el.className = type;
      }

      function handleScan(decodedText) {
        if (scanningDisabled) return;
        scanningDisabled = true;

        const week = document.getElementById("week").value;
        showStatus("â³ Mengirim data...", "");

        fetch("/api/absensi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId: decodedText, week }),
        })
          .then((r) => r.json())
          .then((res) => {
            console.log("Server response:", res);
            if (res.status === "ok") {
              showStatus(
                `âœ… ${res.studentName}<span class="id">${res.studentId}</span><br>hadir Topik ${res.week}`,
                "success"
              );
              // âœ… Play beep once
              beepSound.pause();
              beepSound.currentTime = 0;
              beepSound.play().catch((e) => console.warn("Beep blocked:", e));
            } else if (res.status === "not found") {
              showStatus(`âŒ ${res.message}`, "error");
            } else {
              showStatus("âš ï¸ Respon tidak valid dari server", "error");
            }
          })
          .catch((err) => {
            console.error("Fetch error:", err);
            showStatus("âš ï¸ Koneksi error!", "error");
          })
          .finally(() => {
            // Wait 2 seconds before allowing another scan
            setTimeout(() => {
              scanningDisabled = false;
            }, 2000);
          });
      }

      window.onload = () => startScanner();
    </script>
  </body>
</html>
