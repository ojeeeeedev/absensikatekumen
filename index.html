<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Katekumen</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        font-family: "Inter", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }
      h1 {
        margin: 1rem 0 0.4rem 0;
        font-size: 1.8rem;
        color: #00aaff;
        text-align: center;
      }
      label {
        font-size: 1.2rem;
        margin-top: 0.6rem;
      }
      select {
        width: 90%;
        max-width: 420px;
        background: #111;
        color: #fff;
        font-size: 1.1rem;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #333;
        margin-top: 0.4rem;
      }
      #reader {
        width: 92vw;
        max-width: 420px;
        aspect-ratio: 1 / 1;
        margin-top: 1rem;
        border-radius: 14px;
        overflow: hidden;
        background: #000;
      }
      #status {
        margin-top: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        width: 90%;
        max-width: 420px;
        padding: 0.8rem;
        border-radius: 8px;
      }
      .success { background: #00c851; color: #fff; }
      .error { background: #ff4444; color: #fff; }
      footer {
        font-size: 0.9rem;
        color: #666;
        margin-top: auto;
        padding-bottom: 0.6rem;
      }
    </style>
  </head>

  <body>
    <h1>Absensi Katekumen</h1>

    <label for="week">Pilih Topik:</label>
    <select id="week">
      <option value="1">Topik 1</option>
      <option value="2">Topik 2</option>
      <option value="3">Topik 3</option>
      <option value="4">Topik 4</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

    <footer>Â© 2025 IT Katekumen Dewasa - St. Petrus Katedral</footer>

    <script>
  const reader = new Html5Qrcode("reader");

  async function startScanner() {
    try {
      // Stop any existing scanner before restarting
      if (reader.isScanning) {
        await reader.stop();
      }

      // Explicitly request the back camera
      await reader.start(
        { facingMode: { exact: "environment" } },
        { fps: 10, qrbox: { width: 350, height: 350 } },
        (decodedText) => handleScan(decodedText)
      );

    } catch (err) {
      console.warn("Camera Error, fallback to auto:", err);

      // If environment camera not available, fallback to default
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras && cameras.length > 0) {
          const backCam = cameras.find(cam =>
            cam.label.toLowerCase().includes("back") ||
            cam.label.toLowerCase().includes("rear")
          ) || cameras[0];

          await reader.start(
            { deviceId: { exact: backCam.id } },
            { fps: 10, qrbox: { width: 350, height: 350 } },
            (decodedText) => handleScan(decodedText)
          );
        } else {
          showStatus("ðŸš« Tidak ada kamera yang terdeteksi", "error");
        }
      } catch (fallbackErr) {
        console.error("Camera Fallback Error:", fallbackErr);
        showStatus("âš ï¸ Tidak bisa mengakses kamera", "error");
      }
    }
  }

  function showStatus(text, type) {
    const el = document.getElementById("status");
    el.textContent = text;
    el.className = type;
  }

  function handleScan(decodedText) {
    const week = document.getElementById("week").value;
    showStatus("â³ Mengirim data...", "");

    fetch("https://script.google.com/macros/s/AKfycbxHvi5ye-wF_ov-a_uF2JEnY9VzAnXZx36Cez5LHTdLQUpvSw9CcDwfijdONxgfPHlsZA/exec?nocache=" + Date.now(), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ studentId: decodedText, week }),
    })
      .then((r) => r.json())
      .then((res) => {
        if (res.status === "ok") {
          showStatus(`âœ… ${res.name} (${res.id}) hadir Topik ${week}`, "success");
          new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg").play();
        } else {
          showStatus("âŒ Data tidak ditemukan!", "error");
        }
      })
      .catch((err) => {
        console.error(err);
        showStatus("âš ï¸ Koneksi error!", "error");
      });
  }

  window.onload = () => startScanner();
</script>

