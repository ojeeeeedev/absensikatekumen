<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Katekumen</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <style>
      * {
        box-sizing: border-box;
      }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        font-family: "Inter", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }
      h1 {
        margin: 1rem 0 0.4rem 0;
        font-size: 2.2rem;
        color: #00ffff;
        text-align: center;
      }
      label {
        font-size: 1.2rem;
        margin-top: 0.6rem;
      }
      select {
        width: 90%;
        max-width: 420px;
        background: #111;
        color: #fff;
        font-size: 1.1rem;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #333;
        margin-top: 0.4rem;
      }
      #reader {
        width: 92vw;
        max-width: 420px;
        aspect-ratio: 1 / 1;
        margin-top: 1rem;
        border-radius: 14px;
        overflow: hidden;
        background: #000;
      }
      #status {
        margin-top: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        width: 90%;
        max-width: 420px;
        padding: 0.8rem;
        border-radius: 8px;
      }
      .success {
        background: #00c851;
        color: #fff;
      }
      .error {
        background: #ff4444;
        color: #fff;
      }
      .student-id {
        font-size: 0.9rem;
        font-weight: 400;
        opacity: 0.9;
      }
      footer {
        font-size: 0.9rem;
        color: #666;
        margin-top: auto;
        padding-bottom: 0.6rem;
      }
    </style>
  </head>

  <body>
    <h1>Absensi Katekumen</h1>

    <label for="week">Pilih Topik:</label>
    <select id="week">
      <option value="1">Topik 1</option>
      <option value="2">Topik 2</option>
      <option value="3">Topik 3</option>
      <option value="4">Topik 4</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

   <footer class="site-footer">
  <p>¬© 2025 IT Katekumen Dewasa - St. Petrus Katedral</p>
  <p>
    <a href="https://github.com/ojeeeeedev" target="_blank" rel="noopener noreferrer">
      github.com/ojeeeeedev
    </a>
  </p>
</footer>

    <script>
      const reader = new Html5Qrcode("reader");
      let scanCooldown = false;

      async function startScanner() {
        try {
          await reader.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 350, height: 350 } },
            (decodedText) => handleScan(decodedText)
          );
        } catch (err) {
          console.error("Camera Error:", err);
          showStatus("‚ö†Ô∏è Tidak bisa mengakses kamera", "error");
        }
      }

      function showStatus(text, type) {
        const el = document.getElementById("status");
        el.innerHTML = text;
        el.className = type;
      }

      function handleScan(decodedText) {
        if (scanCooldown) return;
        scanCooldown = true;

        const week = document.getElementById("week").value;
        showStatus("‚è≥ Mengirim data...", "");

        fetch("/api/absensi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId: decodedText, week }),
        })
          .then(async (r) => {
            const text = await r.text();
            console.log("Raw response:", text);

            let res;
            try {
              res = JSON.parse(text);
            } catch {
              showStatus("‚ö†Ô∏è Server mengirim data tidak valid.", "error");
              return;
            }

            if (res.status === "ok") {
              showStatus(
                `‚úÖ <b>${res.name}</b><br>hadir <b>Topik ${week}</b><br><span class="student-id">${res.studentId.toUpperCase()}</span>`,
                "success"
              );
            } else {
              showStatus(`‚ùå ${res.message || "Data tidak ditemukan!"}`, "error");
            }
          })
          .catch((err) => {
            console.error("Fetch failed:", err);
            showStatus("‚ö†Ô∏è Koneksi error!", "error");
          })
          .finally(() => {
            setTimeout(() => {
              scanCooldown = false;
              showStatus("üì∑ Siap scan berikutnya", "");
            }, 3000);
          });
      }

      window.onload = () => startScanner();
    </script>
  </body>
</html>
