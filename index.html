<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Katekumen</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />

    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        font-family: "Inter", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }
      h1 {
        margin: 1rem 0 0.4rem 0;
        font-size: 2.2rem;
        color: #ffffff;
        text-align: center;
      }
      h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #aaa;
        text-align: center;
        font-weight: 500;
      }
      label {
        font-size: 1.2rem;
        margin-top: 0.6rem;
      }
      select {
        width: 90%;
        max-width: 420px;
        background: #111;
        color: #fff;
        font-size: 1.1rem;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #333;
        margin-top: 0.4rem;
      }
      #reader {
        width: 92vw;
        max-width: 420px;
        aspect-ratio: 1 / 1;
        margin-top: 1rem;
        border-radius: 14px;
        overflow: hidden;
        background: #000;
      }
      #status {
        margin-top: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        width: 90%;
        max-width: 420px;
        padding: 0.8rem;
        border-radius: 8px;
        transition: opacity 0.4s ease;
      }
      .success { background: #00c851; color: #fff; }
      .error { background: #ff4444; color: #fff; }
      .student-id {
        font-size: 0.9rem;
        font-weight: 400;
        opacity: 0.9;
      }
      footer {
        font-size: 0.9rem;
        color: #666;
        margin-top: auto;
        padding-bottom: 0.6rem;
      }
    </style>
  </head>

  <body>
    <h1>Presensi Katekumen Dewasa</h1>
    <h2>Gereja Katedral St. Petrus Bandung</h2>

    <label for="week">Pilih Topik:</label>
    <select id="week">
      <option disabled selected>Memuat daftar topik...</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

    <footer><center><b>¬© 2025 Tim TI Katekumen Dewasa - St. Petrus Katedral Bandung</b>
	<br>Ada kendala/kritik/saran? Kontak: Andar - WA 0812 2175 2365 </br></center></footer>

    <script>
      const reader = new Html5Qrcode("reader");
      let scanCooldown = false;

      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxB3TcQA-bsX5hgXi4mL1v__-RL4HGzy8D6QJdeWy0-x737yw3sTGxvFbFdEc07zJfepQ/exec";

      async function loadTopikList() {
        const select = document.getElementById("week");
        select.innerHTML = `<option disabled selected>Memuat daftar topik...</option>`;

        try {
          const res = await fetch(`${SCRIPT_URL}?action=topik`);
          const data = await res.json();

          select.innerHTML = "";

          if (data.status === "ok" && Array.isArray(data.topik) && data.topik.length > 0) {
            data.topik.forEach((item) => {
              const opt = document.createElement("option");
              opt.value = item.week;
              opt.textContent = `${item.week}. ${item.name}`;
              select.appendChild(opt);
            });
          } else {
            select.innerHTML = `<option disabled>Data topik tidak ditemukan</option>`;
          }
        } catch (err) {
          console.error("Gagal memuat daftar topik:", err);
          select.innerHTML = `<option disabled>‚ö†Ô∏è Gagal memuat topik</option>`;
        }
      }

      async function startScanner() {
        try {
          await reader.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 350, height: 350 } },
            (decodedText) => handleScan(decodedText)
          );
        } catch (err) {
          console.error("Camera Error:", err);
          showStatus("‚ö†Ô∏è Tidak bisa mengakses kamera", "error");
        }
      }

      function showStatus(text, type) {
        const el = document.getElementById("status");
        el.innerHTML = text;
        el.className = type;
        el.style.opacity = "1";
      }

      function clearStatus() {
        const el = document.getElementById("status");
        el.style.opacity = "0";
        setTimeout(() => {
          el.innerHTML = "üì∑ Silakan pindai kode QR berikutnya";
          el.className = "";
          el.style.opacity = "1";
        }, 400);
      }

      function handleScan(decodedText) {
        if (scanCooldown) return;
        scanCooldown = true;

        const week = document.getElementById("week").value;
        showStatus("‚è≥ Menyimpan presensi...", "");

        fetch("/api/absensi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId: decodedText, week }),
        })
          .then(async (r) => {
            const text = await r.text();
            console.log("Raw response:", text);

            let res;
            try {
              res = JSON.parse(text);
            } catch {
              showStatus("‚ö†Ô∏è Server mengirim data tidak valid.", "error");
              return;
            }

            if (res.status === "ok") {
  		showStatus(
    		`‚úÖ Presensi <b>${res.name}</b><br> tersimpan  untuk </br> <b>Topik ${week}</b><br><span class="student-id">${res.studentId.toUpperCase()}		</span>`,
   		 "success"
	  );
} else if (res.status === "duplicate") {
  showStatus(
    `‚ö†Ô∏è ${res.message}`,
    "error"
  );
} else {
  showStatus(`‚ùå ${res.message || "Data tidak ditemukan!"}`, "error");
}

          })
          .catch((err) => {
            console.error("Fetch failed:", err);
            showStatus("‚ö†Ô∏è Koneksi error!", "error");
          })
          .finally(() => {
            setTimeout(() => {
              scanCooldown = false;
              clearStatus();
            }, 3000);
          });
      }

      window.onload = async () => {
        await loadTopikList();
        startScanner();
      };
    </script>
  </body>
</html>
